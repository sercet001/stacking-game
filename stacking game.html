<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç–Šç©æœ¨éŠæˆ²</title>
    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Tailwind CSS CDN
        const tailwindScript = document.createElement('script');
        tailwindScript.src = "https://cdn.tailwindcss.com";
        document.head.appendChild(tailwindScript);

        // Wait for Tailwind to load if needed, though usually it's fast enough
        tailwindScript.onload = () => {
            // All game logic will be inside this onload to ensure DOM and Firebase are ready
            initializeGameLogic();
        };

        // Firebase variables
        let app;
        let db;
        let auth;
        let userId = 'anonymous'; // Default to anonymous until authenticated

        async function initializeFirebase() {
            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Sign in anonymously or with custom token
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                    console.log("Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("User ID:", userId);
                        loadGameData(); // Load data once authenticated
                    } else {
                        console.log("No user is signed in.");
                        // Handle case where user signs out or fails to sign in
                    }
                });
            } catch (error) {
                console.error("Firebase initialization or authentication error:", error);
            }
        }

        // Global variable for customization data (now mutable)
        let characterCustomizationData = {
            bodyColors: [
                { id: 'body_red', name: 'ç´…è‰²è¡£æœ', value: '#ff6347', cost: 0, unlocked: true },
                { id: 'body_blue', name: 'è—è‰²è¡£æœ', value: '#4682b4', cost: 0, unlocked: true },
                { id: 'body_green', name: 'ç¶ è‰²è¡£æœ', value: '#3cb371', cost: 10, unlocked: false },
                { id: 'body_purple', name: 'ç´«è‰²è¡£æœ', value: '#8a2be2', cost: 15, unlocked: false },
            ],
            eyeStyles: [
                { id: 'eyes_dot', name: 'é»é»çœ¼', type: 'dot', cost: 0, unlocked: true },
                { id: 'eyes_line', name: 'ç›´ç·šçœ¼', type: 'line', cost: 0, unlocked: true },
                { id: 'eyes_wide', name: 'å¤§çœ¼ç›', type: 'wide', cost: 5, unlocked: false },
                { id: 'eyes_closed', name: 'é–‰çœ¼', type: 'closed', cost: 8, unlocked: false },
            ],
            // Removed accessories category as per user request
            // accessories: [
            //     { id: 'acc_none', name: 'ç„¡é£¾å“', type: 'none', cost: 0, unlocked: true },
            //     { id: 'acc_cat_ears', name: 'è²“è€³æœµ', type: 'cat_ears', cost: 15, unlocked: false },
            //     { id: 'acc_bunny_ears', name: 'å…”è€³æœµ', type: 'bunny_ears', cost: 20, unlocked: false },
            // ]
        };

        // Current selected customization items
        let currentCustomization = {
            bodyColor: 'body_red',
            eyeStyle: 'eyes_dot',
            accessory: 'acc_none' // Keep this to avoid breaking existing save data, but it will default to 'none'
        };

        async function loadGameData() {
            if (!db || !userId) {
                console.log("Firestore not ready or user not authenticated to load data.");
                return;
            }
            try {
                const userDocRef = doc(db, `artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/users/${userId}/gameData/userData`); // Use a more general doc name
                onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        goldCoins = data.goldCoins || 0;
                        
                        // Load and merge customization data to handle new items
                        if (data.characterCustomizationData) {
                            Object.keys(characterCustomizationData).forEach(categoryKey => {
                                if (data.characterCustomizationData[categoryKey]) {
                                    characterCustomizationData[categoryKey].forEach(item => {
                                        const loadedItem = data.characterCustomizationData[categoryKey].find(loaded => loaded.id === item.id);
                                        if (loadedItem) {
                                            item.unlocked = loadedItem.unlocked; // Update unlocked status
                                        }
                                    });
                                }
                            });
                        }
                        // Load current selected items, ensure 'accessory' defaults to 'none' if it was a removed item
                        currentCustomization = data.currentCustomization || currentCustomization;
                        if (!characterCustomizationData.accessories && currentCustomization.accessory !== 'acc_none') {
                            currentCustomization.accessory = 'acc_none'; // Force to 'none' if accessories are removed
                        }


                        console.log("Game data loaded:", data);
                    } else {
                        console.log("No game data found for user, initializing to default.");
                        goldCoins = 0;
                        // characterCustomizationData and currentCustomization are already at their default values
                        saveGameData(); // Save initial state if no data exists
                    }
                    goldCoinsDisplay.textContent = goldCoins;
                    modalGoldCoinsDisplay.textContent = goldCoins;
                    renderCustomizationOptions(); // Re-render options based on loaded/updated gold
                    // Also update character's current appearance based on loaded data
                    if (character && characterCustomizationData.bodyColors.length > 0) { // Ensure character object exists before updating
                        character.color = characterCustomizationData.bodyColors.find(item => item.id === currentCustomization.bodyColor).value;
                    }
                }, (error) => {
                    console.error("Error listening to game data:", error);
                });
            } catch (error) {
                console.error("Error loading game data:", error);
            }
        }

        async function saveGameData() {
            if (!db || !userId) {
                console.log("Firestore not ready or user not authenticated to save data.");
                return;
            }
            try {
                const userDocRef = doc(db, `artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/users/${userId}/gameData/userData`);
                await setDoc(userDocRef, {
                    goldCoins: goldCoins,
                    characterCustomizationData: characterCustomizationData, // Save the entire object
                    currentCustomization: currentCustomization // Save current selected items
                }, { merge: true });
                console.log("Game data saved successfully.");
            } catch (error) {
                console.error("Error saving game data:", error);
            }
        }

        // Main game logic function, called after Firebase is initialized
        function initializeGameLogic() {
            // ç²å– DOM å…ƒç´ 
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            const scoreDisplay = document.getElementById('score');
            const goldCoinsDisplay = document.getElementById('goldCoins');
            const gameOverOverlay = document.getElementById('gameOverOverlay');
            const finalScoreDisplay = document.getElementById('finalScore');
            const restartButton = document.getElementById('restartButton');
            const characterButton = document.getElementById('characterButton');
            const characterCustomizationModal = document.getElementById('characterCustomizationModal');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const modalGoldCoinsDisplay = document.getElementById('modalGoldCoins');
            const startScreen = document.getElementById('startScreen');
            const startButton = document.getElementById('startButton');
            const gameContainer = document.getElementById('gameContainer');

            // éŠæˆ²å¸¸æ•¸
            const GRAVITY = 0.5; // é‡åŠ›åŠ é€Ÿåº¦
            const JUMP_STRENGTH = -10; // è·³èºåŠ›é‡
            const CHARACTER_SIZE = 40; // è§’è‰²å¤§å°
            const BLOCK_HEIGHT = 40; // ç©æœ¨é«˜åº¦
            const BLOCK_WIDTH_MIN = 80; // ç©æœ¨æœ€å°å¯¬åº¦
            const BLOCK_WIDTH_MAX = 150; // ç©æœ¨æœ€å¤§å¯¬åº¦
            const SLIDING_SPEED = 3; // ç©æœ¨æ°´å¹³ç§»å‹•é€Ÿåº¦
            const GAME_WIDTH = 600; // éŠæˆ²å…§éƒ¨é‚è¼¯å¯¬åº¦
            const GAME_HEIGHT = 400; // éŠæˆ²å…§éƒ¨é‚è¼¯é«˜åº¦
            const TABLE_HEIGHT = 20; // åˆå§‹æ¡Œé¢é«˜åº¦
            const BLOCK_SPAWN_MIN_INTERVAL = 3000; // 3 ç§’
            const BLOCK_SPAWN_MAX_INTERVAL = 5000; // 5 ç§’
            const BLOCK_STOP_X_CENTER = GAME_WIDTH / 2; // ç©æœ¨åœæ­¢çš„ä¸­å¿ƒXåº§æ¨™

            // éŠæˆ²ç‹€æ…‹è®Šæ•¸
            let score = 0;
            let goldCoins = 0; // é‡‘å¹£ (æœƒå¾ Firestore åŠ è¼‰)
            let gameOver = false;
            let character = {};
            let groundBlocks = []; // å„²å­˜æ‰€æœ‰å †ç–Šçš„ç©æœ¨ (åŒ…æ‹¬åˆå§‹æ¡Œå­)
            let slidingBlock = null; // æ­£åœ¨æ»‘å‹•çš„ç©æœ¨
            let blockSpawnTimer = 0; // ç©æœ¨ç”Ÿæˆè¨ˆæ™‚å™¨
            let blockSpawnInterval = 0; // ä¸‹ä¸€å€‹ç©æœ¨ç”Ÿæˆçš„é–“éš”æ™‚é–“
            let lastFrameTime = 0; // ç”¨æ–¼è¨ˆç®— deltaTime
            let cameraY = 0; // æ”å½±æ©Ÿçš„Yè»¸åç§»é‡ï¼Œç”¨æ–¼è¢å¹•è·Ÿéš¨
            let lastScoreMilestoneForCoins = 0; // è¿½è¹¤ä¸Šæ¬¡ç²å¾—é‡‘å¹£çš„åˆ†æ•¸é‡Œç¨‹ç¢‘

            let animationFrameId = null; // ç”¨æ–¼å„²å­˜ requestAnimationFrame çš„ ID

            // èƒŒæ™¯åœ–ç‰‡
            let backgroundImage = new Image();
            backgroundImage.src = 'https://source.unsplash.com/random/600x800/?sky,clouds'; // éš¨æ©Ÿå¤©ç©ºé›²æœµåœ–ç‰‡ï¼Œç¨å¾®é«˜ä¸€é»ä»¥ä¾¿æ»¾å‹•
            // å¦‚æœåœ–ç‰‡è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨é è¨­èƒŒæ™¯è‰²
            backgroundImage.onerror = () => {
                console.error("èƒŒæ™¯åœ–ç‰‡è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨é è¨­é¡è‰²ã€‚");
                // å¯ä»¥é¸æ“‡åœ¨é€™è£¡è¨­å®šä¸€å€‹æ¨™èªŒï¼Œè®“ draw å‡½æ•¸çŸ¥é“ä½¿ç”¨ç´”è‰²èƒŒæ™¯
            };


            // èª¿æ•´ Canvas å…§éƒ¨ç¹ªåœ–å°ºå¯¸
            function resizeCanvas() {
                canvas.width = GAME_WIDTH;
                canvas.height = GAME_HEIGHT;
                // CSSæœƒè™•ç†å¯¦éš›é¡¯ç¤ºå°ºå¯¸çš„ç¸®æ”¾ï¼Œæ‰€ä»¥é€™è£¡ä¸å†è¨­å®šstyle
            }

            // è§’è‰²ç‰©ä»¶
            function Character() {
                this.width = CHARACTER_SIZE;
                this.height = CHARACTER_SIZE;
                this.x = (GAME_WIDTH - this.width) / 2; // è§’è‰²æ°´å¹³å±…ä¸­
                this.y = 0; // åˆå§‹Yåº§æ¨™ï¼Œæœƒåœ¨initGameä¸­è¨­å®šåˆ°åœ°é¢
                this.velocityY = 0;
                this.isJumping = false;
                this.isFalling = true; // è§’è‰²åˆå§‹ç‹€æ…‹ç‚ºä¸‹è½ï¼Œç›´åˆ°è½åœ¨åœ°é¢ä¸Š
                this.color = '#ff6347'; // è§’è‰²è¡£æœé¡è‰² (ç•ªèŒ„ç´…)

                // æ›´æ–°è§’è‰²ç‹€æ…‹
                this.update = function() {
                    if (gameOver) return;

                    const prevY = this.y; // å„²å­˜ä¸Šä¸€å¹€çš„Yåº§æ¨™ï¼Œç”¨æ–¼åˆ¤æ–·æ˜¯å¦è½åœ°

                    this.velocityY += GRAVITY; // æ–½åŠ é‡åŠ›
                    this.y += this.velocityY; // æ›´æ–°Yåº§æ¨™

                    let effectiveGroundY = GAME_HEIGHT; // é è¨­åœ°é¢ç‚ºç•«å¸ƒåº•éƒ¨ï¼ˆä½†å¯¦éš›ä¸Šæœƒè¢«ç©æœ¨è¦†è“‹ï¼‰
                    let currentGroundObject = null; // å„²å­˜è§’è‰²ç•¶å‰ç«™ç«‹çš„ç‰©é«”

                    // éæ­·æ‰€æœ‰å·²åœæ­¢çš„åœ°é¢ç©æœ¨ (åŒ…æ‹¬åˆå§‹æ¡Œå­å’Œå·²åœæ­¢çš„ç©æœ¨)
                    // æ‰¾åˆ°è§’è‰²å¯èƒ½ç«™ç«‹çš„æœ€é«˜åœ°é¢ç©æœ¨
                    for (const block of groundBlocks) {
                        // æª¢æŸ¥æ°´å¹³é‡ç–Š
                        if (this.x < block.x + block.width && this.x + this.width > block.x) {
                            // æª¢æŸ¥è§’è‰²æ˜¯å¦æœƒè½åœ¨é€™å€‹ç©æœ¨é ‚éƒ¨
                            // åˆ¤æ–·æ¢ä»¶ï¼šè§’è‰²ä¸Šä¸€å¹€åœ¨ç©æœ¨ä¸Šæ–¹ï¼Œç•¶å‰å¹€æˆ–ä¸‹ä¸€å¹€æœƒæ¥è§¸ç©æœ¨é ‚éƒ¨
                            // å¢åŠ ä¸€å€‹å°å®¹éŒ¯å€¼ (+1) ç¢ºä¿ç²¾ç¢ºè½åœ°
                            if (prevY + this.height <= block.y + 1 && this.y + this.height >= block.y) {
                                if (block.y < effectiveGroundY) { // æ‰¾åˆ°æœ€é«˜çš„æœ‰æ•ˆåœ°é¢
                                    effectiveGroundY = block.y;
                                    currentGroundObject = block;
                                }
                            }
                        }
                    }

                    // ä¹Ÿæª¢æŸ¥æ­£åœ¨æ»‘å‹•çš„ç©æœ¨ï¼Œå¦‚æœè§’è‰²æœƒè½åœ¨ä¸Šé¢
                    if (slidingBlock && slidingBlock.isSliding) {
                        if (this.x < slidingBlock.x + slidingBlock.width && this.x + this.width > slidingBlock.x) {
                            if (prevY + this.height <= slidingBlock.y + 1 && this.y + this.height >= slidingBlock.y) {
                                if (slidingBlock.y < effectiveGroundY) { // æ‰¾åˆ°æœ€é«˜çš„æœ‰æ•ˆåœ°é¢
                                    effectiveGroundY = slidingBlock.y;
                                    currentGroundObject = slidingBlock;
                                }
                            }
                        }
                    }
                    
                    // æ‡‰ç”¨è½åœ°é‚è¼¯
                    if (this.y + this.height >= effectiveGroundY) {
                        this.y = effectiveGroundY - this.height; // é‡˜åœ¨åœ°é¢ä¸Š
                        this.velocityY = 0;
                        this.isJumping = false;
                        this.isFalling = false;
                    } else {
                        this.isFalling = true;
                    }

                    // å¦‚æœè§’è‰²ç«™åœ¨å‹•æ…‹ (æ»‘å‹•ä¸­) çš„ç©æœ¨ä¸Šï¼Œå‰‡éš¨ç©æœ¨ç§»å‹•
                    if (currentGroundObject === slidingBlock && slidingBlock && slidingBlock.isSliding) {
                        this.x = slidingBlock.x + (slidingBlock.width / 2) - (this.width / 2);
                    } else {
                        // å¦å‰‡ï¼Œè§’è‰²ä¿æŒåœ¨æ¡Œå­ä¸­å¿ƒ
                        this.x = (GAME_WIDTH - this.width) / 2;
                    }
                };

                // ç¹ªè£½è§’è‰² (ç°¡åŒ–å¥³å­©å½¢è±¡)
                this.draw = function() {
                    // ç¹ªè£½é ­éƒ¨ (æ·ºè†šè‰²åœ“å½¢)
                    ctx.fillStyle = '#fdd8c7'; // æ·ºè†šè‰²
                    ctx.beginPath();
                    ctx.arc(this.x + this.width / 2, this.y + this.height / 3, this.width / 3, 0, Math.PI * 2);
                    ctx.fill();

                    // ç¹ªè£½èº«é«” (ä½¿ç”¨è§’è‰²ä¸»è‰²)
                    ctx.fillStyle = characterCustomizationData.bodyColors.find(
                        item => item.id === currentCustomization.bodyColor
                    ).value;
                    ctx.fillRect(this.x + this.width / 4, this.y + this.height / 2, this.width / 2, this.height / 2);

                    // ç¹ªè£½çœ¼ç›
                    ctx.fillStyle = 'black'; // çœ¼ç›é¡è‰²
                    const eyeY = this.y + this.height / 3; // çœ¼ç›çš„å‚ç›´ä½ç½®

                    switch (currentCustomization.eyeStyle) {
                        case 'eyes_dot':
                            ctx.beginPath();
                            ctx.arc(this.x + this.width / 2 - 8, eyeY, 3, 0, Math.PI * 2); // å·¦çœ¼
                            ctx.arc(this.x + this.width / 2 + 8, eyeY, 3, 0, Math.PI * 2); // å³çœ¼
                            ctx.fill();
                            break;
                        case 'eyes_line':
                            ctx.fillRect(this.x + this.width / 2 - 10, eyeY, 5, 2); // å·¦çœ¼ (ç›´ç·š)
                            ctx.fillRect(this.x + this.width / 2 + 5, eyeY, 5, 2); // å³çœ¼ (ç›´ç·š)
                            break;
                        case 'eyes_wide':
                            ctx.beginPath();
                            ctx.arc(this.x + this.width / 2 - 8, eyeY, 5, 0, Math.PI * 2); // å·¦çœ¼
                            ctx.arc(this.x + this.width / 2 + 8, eyeY, 5, 0, Math.PI * 2); // å³çœ¼
                            ctx.fill();
                            break;
                        case 'eyes_closed':
                            ctx.strokeStyle = 'black'; // çœ¼ç›é–‰åˆç·šæ¢é¡è‰²
                            ctx.lineWidth = 2;
                            ctx.beginPath();
                            ctx.moveTo(this.x + this.width / 2 - 10, eyeY);
                            ctx.lineTo(this.x + this.width / 2 - 5, eyeY + 2);
                            ctx.stroke(); // å·¦çœ¼é–‰åˆ
                            ctx.beginPath();
                            ctx.moveTo(this.x + this.width / 2 + 5, eyeY);
                            ctx.lineTo(this.x + this.width / 2 + 10, eyeY + 2);
                            ctx.stroke(); // å³çœ¼é–‰åˆ
                            ctx.lineWidth = 1; // é‡ç½®ç·šæ¢å¯¬åº¦
                            break;
                    }

                    // Removed accessory drawing logic as per user request
                    // ctx.fillStyle = '#a0522d'; // è€³æœµé¡è‰² (æ£•è‰²)
                    // const headTopY = this.y + this.height / 3 - this.width / 3; // é ­éƒ¨åœ“å½¢çš„é ‚éƒ¨

                    // switch (currentCustomization.accessory) {
                    //     case 'acc_cat_ears':
                    //         // å·¦è€³
                    //         ctx.beginPath();
                    //         ctx.moveTo(this.x + this.width / 2 - 15, headTopY);
                    //         ctx.lineTo(this.x + this.width / 2 - 5, headTopY - 10);
                    //         ctx.lineTo(this.x + this.width / 2 - 5, headTopY);
                    //         ctx.fill();
                    //         // å³è€³
                    //         ctx.beginPath();
                    //         ctx.moveTo(this.x + this.width / 2 + 15, headTopY);
                    //         ctx.lineTo(this.x + this.width / 2 + 5, headTopY - 10);
                    //         ctx.lineTo(this.x + this.width / 2 + 5, headTopY);
                    //         ctx.fill();
                    //         break;
                    //     case 'acc_bunny_ears':
                    //         // å·¦è€³
                    //         ctx.fillRect(this.x + this.width / 2 - 12, headTopY - 20, 5, 20);
                    //         // å³è€³
                    //         ctx.fillRect(this.x + this.width / 2 + 7, headTopY - 20, 5, 20);
                    //         break;
                    // }
                };

                // è§’è‰²è·³èº
                this.jump = function() {
                    // åªæœ‰ç•¶è§’è‰²ä¸åœ¨è·³èºä¸­ä¸”ä¸åœ¨ä¸‹è½ä¸­ (å³åœ¨åœ°é¢ä¸Š) æ‰èƒ½è·³èº
                    if (!this.isJumping && !this.isFalling && !gameOver) {
                        this.velocityY = JUMP_STRENGTH;
                        this.isJumping = true;
                    }
                };
            }

            // ç©æœ¨ç‰©ä»¶ (ç¾åœ¨åªæœƒæ°´å¹³æ»‘å‹•ï¼Œç„¶å¾Œåœæ­¢)
            function Block(x, y, width, height) {
                this.x = x;
                this.y = y;
                this.width = width;
                this.height = height;
                this.color = `hsl(${Math.random() * 360}, 70%, 60%)`; // éš¨æ©Ÿé¡è‰²
                this.velocityX = SLIDING_SPEED; // æ†å®šæ°´å¹³æ»‘å‹•é€Ÿåº¦
                this.isSliding = true; // æ¨™è¨˜æ˜¯å¦æ­£åœ¨æ»‘å‹•
                this.passedCharacterCenter = false; // ç”¨æ–¼å¾—åˆ†åˆ¤æ–·

                // æ›´æ–°ç©æœ¨ç‹€æ…‹ (åªæ°´å¹³ç§»å‹•)
                this.update = function() {
                    if (gameOver || !this.isSliding) return; // å¦‚æœéŠæˆ²çµæŸæˆ–ç©æœ¨å·²åœæ­¢ï¼Œå‰‡ä¸æ›´æ–°

                    this.x += this.velocityX;
                };

                // ç¹ªè£½ç©æœ¨ (å¢åŠ é‚Šæ¡†ä½¿å…¶æ›´åƒç©æœ¨)
                this.draw = function() {
                    ctx.fillStyle = this.color;
                    ctx.fillRect(this.x, this.y, this.width, this.height);
                    ctx.strokeStyle = 'rgba(0, 0, 0, 0.3)'; // æ·±è‰²é‚Šæ¡†
                    ctx.lineWidth = 2; // é‚Šæ¡†åšåº¦
                    ctx.strokeRect(this.x, this.y, this.width, this.height);
                };
            }

            // éŠæˆ²åˆå§‹åŒ–
            function initGame() {
                score = 0;
                // goldCoins ä¸åœ¨initGameé‡ç½®ï¼Œç”± Firestore åŠ è¼‰
                gameOver = false;
                scoreDisplay.textContent = score;
                goldCoinsDisplay.textContent = goldCoins; // æ›´æ–°é‡‘å¹£é¡¯ç¤º
                gameOverOverlay.classList.add('hidden');
                cameraY = 0; // é‡ç½®æ”å½±æ©Ÿä½ç½®
                lastScoreMilestoneForCoins = 0; // é‡ç½®é‡‘å¹£é‡Œç¨‹ç¢‘
                
                // å‰µå»ºåˆå§‹æ¡Œå­ä½œç‚ºç¬¬ä¸€å€‹åœ°é¢ç©æœ¨
                groundBlocks = [
                    new Block(0, GAME_HEIGHT - TABLE_HEIGHT, GAME_WIDTH, TABLE_HEIGHT)
                ];
                groundBlocks[0].color = '#8B4513'; // æ¡Œå­é¡è‰² (æ£•è‰²)
                groundBlocks[0].isSliding = false; // æ¡Œå­ä¸æ»‘å‹•

                // åˆå§‹åŒ–è§’è‰²ä½ç½®åœ¨æ¡Œå­ä¸Š
                character = new Character(); 
                // æ ¹æ“šç•¶å‰é¸ä¸­çš„è‡ªè¨‚é¡è‰²è¨­å®šè§’è‰²è¡£æœé¡è‰²
                if (characterCustomizationData.bodyColors.length > 0) { // ç¢ºä¿æœ‰é¡è‰²æ•¸æ“š
                    character.color = characterCustomizationData.bodyColors.find(
                        item => item.id === currentCustomization.bodyColor
                    ).value;
                }
                character.y = groundBlocks[groundBlocks.length - 1].y - character.height;

                // æ¸…é™¤æ­£åœ¨æ»‘å‹•çš„ç©æœ¨
                slidingBlock = null; 
                
                // ç«‹å³ç”Ÿæˆç¬¬ä¸€å€‹æ»‘å‹•ç©æœ¨
                generateSlidingBlock(); 
                // ç‚ºä¸‹ä¸€å€‹ç©æœ¨è¨­å®šè¨ˆæ™‚å™¨
                resetBlockSpawnTimer(); 

                // å¦‚æœéŠæˆ²å¾ªç’°æ­£åœ¨é‹è¡Œï¼Œå…ˆåœæ­¢å®ƒ
                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                }
                lastFrameTime = 0; // é‡ç½®æ™‚é–“
            }

            // é‡ç½®ç©æœ¨ç”Ÿæˆè¨ˆæ™‚å™¨
            function resetBlockSpawnTimer() {
                blockSpawnTimer = 0;
                // ç‚ºå¾ŒçºŒç©æœ¨è¨­å®šéš¨æ©Ÿé–“éš”
                blockSpawnInterval = BLOCK_SPAWN_MIN_INTERVAL + Math.random() * (BLOCK_SPAWN_MAX_INTERVAL - BLOCK_SPAWN_MIN_INTERVAL);
            }

            // ç”Ÿæˆæ–°çš„æ­£åœ¨æ»‘å‹•çš„ç©æœ¨
            function generateSlidingBlock() {
                const blockWidth = BLOCK_WIDTH_MIN + Math.random() * (BLOCK_WIDTH_MAX - BLOCK_WIDTH_MIN);
                // å¾ç•«å¸ƒå·¦å´å¤–é–‹å§‹ï¼ŒYåº§æ¨™è¨­å®šç‚ºåœ¨ç•¶å‰æœ€é«˜ç©æœ¨çš„é ‚éƒ¨
                slidingBlock = new Block(-blockWidth, groundBlocks[groundBlocks.length - 1].y - BLOCK_HEIGHT, blockWidth, BLOCK_HEIGHT);
            }

            // ç¢°æ’æª¢æ¸¬ (AABB è»¸å°é½Šé‚Šç•Œæ¡†)
            function checkCollision(obj1, obj2) {
                return obj1.x < obj2.x + obj2.width &&
                       obj1.x + obj1.width > obj2.x &&
                       obj1.y < obj2.y + obj2.height &&
                       obj1.y + obj1.height > obj2.y;
            }

            // éŠæˆ²æ›´æ–°é‚è¼¯
            function update(currentTime) {
                if (gameOver) {
                    // å¦‚æœéŠæˆ²çµæŸï¼Œè®“è§’è‰²å¿«é€Ÿä¸‹è½ä»¥é¡¯ç¤ºã€Œæ‰ä¸‹å»ã€çš„æ•ˆæœ
                    character.y += character.velocityY; 
                    character.velocityY += GRAVITY * 2; 
                    // å¦‚æœè§’è‰²å®Œå…¨æ‰å‡ºç•«é¢ï¼Œå‰‡åœæ­¢å‹•ç•«å¾ªç’°
                    if (character.y > groundBlocks[0].y + GAME_HEIGHT) { // è§’è‰²æ‰åˆ°åˆå§‹åœ°é¢ä»¥ä¸‹å¾ˆé 
                        if (animationFrameId) {
                            cancelAnimationFrame(animationFrameId);
                            animationFrameId = null; // æ¸…é™¤ ID
                        }
                    }
                    return; 
                }

                const deltaTime = currentTime - lastFrameTime; // æ¯«ç§’æ•¸
                lastFrameTime = currentTime;

                // è§’è‰²æ›´æ–° (æœƒè‡ªå‹•è™•ç†åœ°é¢å’Œç©æœ¨ä¸Šçš„ç«™ç«‹)
                character.update(); 

                // æ›´æ–°æ”å½±æ©Ÿä½ç½®ï¼Œä½¿è¢å¹•è·Ÿéš¨è§’è‰²
                // è®“è§’è‰²ä¿æŒåœ¨è¢å¹•çš„å‚ç›´ä¸­å¿ƒ
                cameraY = character.y - (GAME_HEIGHT / 2) + (character.height / 2); 
                // é€™è£¡ä¸è¨­ä¸‹é™ï¼Œå¯¦ç¾ç„¡é™å‘ä¸Šæ»¾å‹•çš„æ•ˆæœ

                // æ–°å¢ï¼šæª¢æŸ¥è§’è‰²æ˜¯å¦æ‰è½å‡ºã€ŒéŠæˆ²ä¸–ç•Œã€
                // å¦‚æœè§’è‰²æ‰è½åˆ°æœ€åº•å±¤çš„ç©æœ¨ï¼ˆåˆå§‹æ¡Œå­ï¼‰ä¸‹æ–¹å…©å€è§’è‰²é«˜åº¦ï¼Œå‰‡éŠæˆ²çµæŸ
                if (character.y > groundBlocks[0].y + character.height * 2) { 
                    gameOver = true;
                    character.color = '#8b0000'; // æ’åˆ°å¾Œè®Šæ·±ç´…è‰²
                    showGameOver();
                    return; // éŠæˆ²çµæŸï¼Œåœæ­¢æ›´æ–°
                }

                // ç©æœ¨ç”Ÿæˆé‚è¼¯ï¼šå¦‚æœæ²’æœ‰æ­£åœ¨æ»‘å‹•çš„ç©æœ¨ï¼Œå‰‡æ ¹æ“šè¨ˆæ™‚å™¨ç”Ÿæˆ
                if (slidingBlock === null) {
                    blockSpawnTimer += deltaTime; 
                    if (blockSpawnTimer >= blockSpawnInterval) {
                        generateSlidingBlock();
                        resetBlockSpawnTimer(); // ç”Ÿæˆå¾Œé‡ç½®è¨ˆæ™‚å™¨ï¼Œç‚ºä¸‹ä¸€å€‹ç©æœ¨æº–å‚™
                    }
                }

                // æ›´æ–°æ­£åœ¨æ»‘å‹•çš„ç©æœ¨
                if (slidingBlock && slidingBlock.isSliding) { 
                    slidingBlock.update();

                    // ç¢°æ’æª¢æ¸¬ï¼š
                    // å¦‚æœè§’è‰²èˆ‡ç©æœ¨ç™¼ç”Ÿç¢°æ’ï¼Œä½†ä¸æ˜¯æˆåŠŸè½åœ¨ç©æœ¨é ‚éƒ¨ï¼Œå‰‡éŠæˆ²çµæŸ
                    if (checkCollision(character, slidingBlock)) {
                        // åˆ¤æ–·è§’è‰²æ˜¯å¦åœ¨ç©æœ¨é ‚ç«¯æˆ–ä¸Šæ–¹ (æœ‰è¶³å¤ çš„é«˜åº¦é¿å…è¢«æ’)
                        // é€™è£¡çš„å®¹éŒ¯å€¼å¯ä»¥èª¿æ•´ï¼Œç¢ºä¿è§’è‰²èƒ½ç²¾ç¢ºè½åœ¨é ‚éƒ¨
                        const isCharacterOnTopOrAbove = (character.y + character.height <= slidingBlock.y + 5); 
                        
                        if (!isCharacterOnTopOrAbove) { // å¦‚æœç¢°æ’ç™¼ç”Ÿä½†è§’è‰²ä¸åœ¨ç©æœ¨é ‚ç«¯æˆ–ä¸Šæ–¹ (è¡¨ç¤ºæ’åˆ°å´é¢æˆ–ä¸‹æ–¹)
                            gameOver = true;
                            character.color = '#8b0000'; // æ’åˆ°å¾Œè®Šæ·±ç´…è‰²
                            showGameOver();
                            return;
                        }
                    }

                    // åˆ¤æ–·ç©æœ¨æ˜¯å¦åˆ°é”ä¸­é–“ä½ç½®ä¸¦åœæ­¢
                    if (slidingBlock.x + slidingBlock.width / 2 >= BLOCK_STOP_X_CENTER && slidingBlock.isSliding) { 
                        slidingBlock.x = BLOCK_STOP_X_CENTER - slidingBlock.width / 2; // é‡˜åœ¨ä¸­é–“
                        slidingBlock.velocityX = 0; // åœæ­¢æ»‘å‹•
                        slidingBlock.isSliding = false; // æ¨™è¨˜ç‚ºå·²åœæ­¢

                        // å°‡åœæ­¢çš„ç©æœ¨æ·»åŠ åˆ°åœ°é¢å †ç–Šä¸­
                        groundBlocks.push(slidingBlock);

                        // å¾—åˆ†é‚è¼¯ï¼šç©æœ¨æ»‘åˆ°ä¸­é–“ï¼Œç„¶å¾Œå¥³å­©è§’è‰²æœ‰è·³èµ·ä¾†ä¸¦å¹³å®‰é™è½ï¼Œæ²’æœ‰è¢«ç©æœ¨æ’åˆ°ã€‚
                        // åªè¦éŠæˆ²æ²’æœ‰çµæŸ (è¡¨ç¤ºè§’è‰²æˆåŠŸé¿é–‹æˆ–ç«™åœ¨ç©æœ¨ä¸Š)ï¼Œå°±å¾—åˆ†
                        score += 3; // æ¯æˆåŠŸè™•ç†ä¸€å€‹ç©æœ¨å¾—3åˆ†
                        scoreDisplay.textContent = score;

                        // æª¢æŸ¥æ˜¯å¦é”åˆ°é‡‘å¹£çå‹µé» (æ¯10åˆ†ä¸€å€‹é‡‘å¹£)
                        const currentScoreMilestone = Math.floor(score / 10);
                        if (currentScoreMilestone > lastScoreMilestoneForCoins) {
                            const newCoinsEarned = currentScoreMilestone - lastScoreMilestoneForCoins;
                            goldCoins += newCoinsEarned; 
                            goldCoinsDisplay.textContent = goldCoins; // æ›´æ–°é‡‘å¹£é¡¯ç¤º
                            lastScoreMilestoneForCoins = currentScoreMilestone;
                            saveGameData(); // ä¿å­˜é‡‘å¹£
                        }
                        
                        slidingBlock = null; // æ¸…é™¤ç•¶å‰æ»‘å‹•ç©æœ¨ï¼Œæº–å‚™ç”Ÿæˆä¸‹ä¸€å€‹
                    }
                }
            }

            // ç¹ªè£½éŠæˆ²ç•«é¢
            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height); // æ¸…ç©ºç•«å¸ƒ

                // ç¹ªè£½èƒŒæ™¯åœ–ç‰‡ (è€ƒæ…®æ”å½±æ©Ÿåç§»é‡)
                // ç‚ºäº†å¯¦ç¾ç„¡é™æ»¾å‹•ï¼Œå¯ä»¥ç¹ªè£½å…©å¼µåœ–ç‰‡ï¼Œç•¶ä¸€å¼µæ»¾å‡ºç•«é¢æ™‚ï¼Œå¦ä¸€å¼µè£œä¸Š
                const parallaxFactor = 0.5; // èƒŒæ™¯ç§»å‹•é€Ÿåº¦ç‚ºæ”å½±æ©Ÿçš„ä¸€åŠï¼Œè£½é€ è¦–å·®æ•ˆæœ
                const bgYOffset = (-cameraY * parallaxFactor) % backgroundImage.height;

                // æª¢æŸ¥åœ–ç‰‡æ˜¯å¦è¼‰å…¥å®Œæˆä¸”æœ‰æ•ˆ
                if (backgroundImage.complete && backgroundImage.naturalHeight !== 0) { 
                    // ç¹ªè£½ç¬¬ä¸€å¼µèƒŒæ™¯
                    ctx.drawImage(backgroundImage, 0, bgYOffset, GAME_WIDTH, backgroundImage.height);
                    // å¦‚æœç¬¬ä¸€å¼µèƒŒæ™¯å·²ç¶“éƒ¨åˆ†æ»¾å‡ºç•«é¢ï¼Œç¹ªè£½ç¬¬äºŒå¼µä¾†ç„¡ç¸«éŠœæ¥
                    if (bgYOffset < 0) {
                        ctx.drawImage(backgroundImage, 0, bgYOffset + backgroundImage.height, GAME_WIDTH, backgroundImage.height);
                    }
                } else {
                    // å¦‚æœåœ–ç‰‡æœªè¼‰å…¥æˆ–è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨é è¨­èƒŒæ™¯è‰²
                    ctx.fillStyle = '#add8e6';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                }

                // ç¹ªè£½æ‰€æœ‰å †ç–Šçš„åœ°é¢ç©æœ¨ (æ¸›å»æ”å½±æ©Ÿåç§»é‡)
                groundBlocks.forEach(block => {
                    ctx.fillStyle = block.color;
                    ctx.fillRect(block.x, block.y - cameraY, block.width, block.height);
                    ctx.strokeStyle = 'rgba(0, 0, 0, 0.3)'; // æ·±è‰²é‚Šæ¡†
                    ctx.lineWidth = 2; // é‚Šæ¡†åšåº¦
                    ctx.strokeRect(block.x, block.y - cameraY, block.width, block.height);
                });

                // ç¹ªè£½æ­£åœ¨æ»‘å‹•çš„ç©æœ¨ (æ¸›å»æ”å½±æ©Ÿåç§»é‡)ï¼Œåªæœ‰ç•¶å®ƒå­˜åœ¨æ™‚æ‰ç¹ªè£½
                if (slidingBlock) {
                    ctx.fillStyle = slidingBlock.color;
                    ctx.fillRect(slidingBlock.x, slidingBlock.y - cameraY, slidingBlock.width, slidingBlock.height);
                    ctx.strokeStyle = 'rgba(0, 0, 0, 0.3)'; // æ·±è‰²é‚Šæ¡†
                    ctx.lineWidth = 2; // é‚Šæ¡†åšåº¦
                    ctx.strokeRect(slidingBlock.x, slidingBlock.y - cameraY, slidingBlock.width, slidingBlock.height);
                }

                // ç¹ªè£½è§’è‰² (æ¸›å»æ”å½±æ©Ÿåç§»é‡)
                // ç¹ªè£½é ­éƒ¨ (æ·ºè†šè‰²åœ“å½¢)
                ctx.fillStyle = '#fdd8c7'; // æ·ºè†šè‰²
                ctx.beginPath();
                ctx.arc(character.x + character.width / 2, character.y + character.height / 3 - cameraY, character.width / 3, 0, Math.PI * 2);
                ctx.fill();

                // ç¹ªè£½èº«é«” (ä½¿ç”¨è§’è‰²ä¸»è‰²)
                ctx.fillStyle = characterCustomizationData.bodyColors.find(
                    item => item.id === currentCustomization.bodyColor
                ).value;
                ctx.fillRect(character.x + character.width / 4, character.y + character.height / 2 - cameraY, character.width / 2, character.height / 2);

                // ç¹ªè£½çœ¼ç›
                ctx.fillStyle = 'black'; // çœ¼ç›é¡è‰²
                const eyeY = character.y + character.height / 3 - cameraY; // çœ¼ç›çš„å‚ç›´ä½ç½® (è€ƒæ…®æ”å½±æ©Ÿ)

                switch (currentCustomization.eyeStyle) {
                    case 'eyes_dot':
                        ctx.beginPath();
                        ctx.arc(character.x + character.width / 2 - 8, eyeY, 3, 0, Math.PI * 2); // å·¦çœ¼
                        ctx.arc(character.x + character.width / 2 + 8, eyeY, 3, 0, Math.PI * 2); // å³çœ¼
                        ctx.fill();
                        break;
                    case 'eyes_line':
                        ctx.fillRect(character.x + character.width / 2 - 10, eyeY, 5, 2); // å·¦çœ¼ (ç›´ç·š)
                        ctx.fillRect(character.x + character.width / 2 + 5, eyeY, 5, 2); // å³çœ¼ (ç›´ç·š)
                        break;
                    case 'eyes_wide':
                        ctx.beginPath();
                        ctx.arc(character.x + character.width / 2 - 8, eyeY, 5, 0, Math.PI * 2); // å·¦çœ¼
                        ctx.arc(character.x + character.width / 2 + 8, eyeY, 5, 0, Math.PI * 2); // å³çœ¼
                        ctx.fill();
                        break;
                    case 'eyes_closed':
                        ctx.strokeStyle = 'black'; // çœ¼ç›é–‰åˆç·šæ¢é¡è‰²
                        ctx.lineWidth = 2;
                        ctx.beginPath();
                        ctx.moveTo(character.x + character.width / 2 - 10, eyeY);
                        ctx.lineTo(character.x + character.width / 2 - 5, eyeY + 2);
                        ctx.stroke(); // å·¦çœ¼é–‰åˆ
                        ctx.beginPath();
                        ctx.moveTo(character.x + character.width / 2 + 5, eyeY);
                        ctx.lineTo(character.x + character.width / 2 + 10, eyeY + 2);
                        ctx.stroke(); // å³çœ¼é–‰åˆ
                        ctx.lineWidth = 1; // é‡ç½®ç·šæ¢å¯¬åº¦
                        break;
                }
                // Removed accessory drawing logic as per user request
            }

            // éŠæˆ²ä¸»å¾ªç’°
            function gameLoop(currentTime) {
                update(currentTime); 
                draw();

                if (!gameOver || animationFrameId) { // åªæœ‰åœ¨éŠæˆ²æœªçµæŸæˆ–å‹•ç•«IDæœ‰æ•ˆæ™‚æ‰ç¹¼çºŒå¾ªç’°
                    animationFrameId = requestAnimationFrame(gameLoop);
                }
            }

            // é¡¯ç¤ºéŠæˆ²çµæŸç•«é¢
            function showGameOver() {
                finalScoreDisplay.textContent = `ä½ çš„åˆ†æ•¸: ${score}`;
                gameOverOverlay.classList.remove('hidden');
            }

            // äººç‰©è‡ªè¨‚ä»‹é¢ç›¸é—œå‡½æ•¸
            function openCustomizationModal() {
                characterCustomizationModal.classList.remove('hidden');
                modalGoldCoinsDisplay.textContent = goldCoins; // æ›´æ–°æ¨¡æ…‹æ¡†ä¸­çš„é‡‘å¹£é¡¯ç¤º
                renderCustomizationOptions(); // æ¸²æŸ“è‡ªè¨‚é¸é …
            }

            function closeCustomizationModal() {
                characterCustomizationModal.classList.add('hidden');
            }

            function renderCustomizationOptions() {
                const bodyColorsContainer = document.getElementById('bodyColorsContainer');
                const eyeStylesContainer = document.getElementById('eyeStylesContainer');
                // const accessoriesContainer = document.getElementById('accessoriesContainer'); // Removed

                bodyColorsContainer.innerHTML = '';
                eyeStylesContainer.innerHTML = '';
                // accessoriesContainer.innerHTML = ''; // Removed

                // æ¸²æŸ“è¡£æœé¡è‰²é¸é …
                characterCustomizationData.bodyColors.forEach(item => {
                    const button = document.createElement('button');
                    button.className = `customization-option-button ${currentCustomization.bodyColor === item.id ? 'selected' : ''}`;
                    button.style.backgroundColor = item.value;
                    
                    if (item.cost > 0 && !item.unlocked) {
                        button.innerHTML = `<span class="cost-tag">${item.cost}ğŸ’°</span>`;
                        if (goldCoins < item.cost) {
                            button.classList.add('not-enough-coins');
                        }
                    } else if (item.unlocked && item.cost > 0) {
                        button.innerHTML = `<span class="cost-tag unlocked">âœ”</span>`; // è§£é–å¾Œé¡¯ç¤ºå‹¾
                    }
                    button.onclick = (e) => handleCustomizationClick('bodyColor', item.id, e);
                    bodyColorsContainer.appendChild(button);
                });

                // æ¸²æŸ“çœ¼ç›æ¨£å¼é¸é …
                characterCustomizationData.eyeStyles.forEach(item => {
                    const button = document.createElement('button');
                    button.className = `customization-option-button ${currentCustomization.eyeStyle === item.id ? 'selected' : ''}`;
                    button.textContent = getEyeStyleEmoji(item.type); // ä½¿ç”¨ Helper å‡½æ•¸ç²å– Emoji
                    
                    if (item.cost > 0 && !item.unlocked) {
                        button.innerHTML += `<span class="cost-tag">${item.cost}ğŸ’°</span>`;
                        if (goldCoins < item.cost) {
                            button.classList.add('not-enough-coins');
                        }
                    } else if (item.unlocked && item.cost > 0) {
                        button.innerHTML += `<span class="cost-tag unlocked">âœ”</span>`;
                    }
                    button.onclick = (e) => handleCustomizationClick('eyeStyle', item.id, e);
                    eyeStylesContainer.appendChild(button);
                });

                // Removed rendering of accessory options as per user request
                // characterCustomizationData.accessories.forEach(item => {
                //     const button = document.createElement('button');
                //     button.className = `customization-option-button ${currentCustomization.accessory === item.id ? 'selected' : ''}`;
                //     button.textContent = getAccessoryEmoji(item.type); // ä½¿ç”¨ Helper å‡½æ•¸ç²å– Emoji
                    
                //     if (item.cost > 0 && !item.unlocked) {
                //         button.innerHTML += `<span class="cost-tag">${item.cost}ğŸ’°</span>`;
                //         if (goldCoins < item.cost) {
                //             button.classList.add('not-enough-coins');
                //         }
                //     } else if (item.unlocked && item.cost > 0) {
                //         button.innerHTML += `<span class="cost-tag unlocked">âœ”</span>`;
                //     }
                //     button.onclick = (e) => handleCustomizationClick('accessory', item.id, e);
                //     accessoriesContainer.appendChild(button);
                // });
            }

            // ç²å–çœ¼ç›æ¨£å¼çš„ Emoji è¡¨ç¤º
            function getEyeStyleEmoji(type) {
                switch (type) {
                    case 'dot': return 'âš«âš«';
                    case 'line': return 'â–â–';
                    case 'wide': return 'ğŸ‘ï¸ğŸ‘ï¸';
                    case 'closed': return 'ã€°ï¸ã€°ï¸';
                    default: return '';
                }
            }

            // Removed getAccessoryEmoji function as per user request
            // ç²å–é£¾å“çš„ Emoji è¡¨ç¤º
            // function getAccessoryEmoji(type) {
            //     switch (type) {
            //         case 'none': return 'ğŸš«';
            //         case 'cat_ears': return 'ğŸ±'; // ä½¿ç”¨è²“å’ª Emoji ä»£è¡¨è²“è€³æœµ
            //         case 'bunny_ears': return 'ğŸ°'; // ä½¿ç”¨å…”å­ Emoji ä»£è¡¨å…”è€³æœµ
            //         default: return '';
            //     }
            // }

            // è™•ç†è‡ªè¨‚é¸é …é»æ“Šäº‹ä»¶
            function handleCustomizationClick(type, itemId, event) {
                console.log(`Clicked ${type}: ${itemId}`);
                const category = characterCustomizationData[type + 's']; // ä¾‹å¦‚ï¼šbodyColors
                const item = category.find(i => i.id === itemId);

                if (!item) {
                    console.error("Item not found:", itemId);
                    return;
                }

                console.log("Item status (before check):", item);
                console.log("Current gold (before check):", goldCoins);
                console.log("Item cost:", item.cost);

                if (item.unlocked) {
                    console.log("Item is already unlocked. Changing selection.");
                    currentCustomization[type] = itemId;
                    // å¦‚æœæ˜¯è¡£æœé¡è‰²ï¼Œç«‹å³æ›´æ–°è§’è‰²é¡è‰²
                    if (type === 'bodyColor') {
                        character.color = item.value;
                    }
                    saveGameData(); // ä¿å­˜ç•¶å‰é¸æ“‡
                    renderCustomizationOptions(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°é¸ä¸­é‚Šæ¡†
                } else {
                    console.log("Item is locked. Attempting to purchase.");
                    // å˜—è©¦è³¼è²·
                    if (goldCoins >= item.cost) {
                        console.log(`Purchasing ${item.name} for ${item.cost} gold. Remaining gold: ${goldCoins - item.cost}`);
                        goldCoins -= item.cost;
                        item.unlocked = true; // Mark as unlocked in data
                        currentCustomization[type] = itemId;
                        if (type === 'bodyColor') {
                            character.color = item.value;
                        }
                        goldCoinsDisplay.textContent = goldCoins; // æ›´æ–°ä¸»éŠæˆ²é‡‘å¹£é¡¯ç¤º
                        modalGoldCoinsDisplay.textContent = goldCoins; // æ›´æ–°æ¨¡æ…‹æ¡†é‡‘å¹£é¡¯ç¤º
                        saveGameData(); // ä¿å­˜é‡‘å¹£å’Œè§£é–ç‹€æ…‹
                        renderCustomizationOptions(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°è§£é–ç‹€æ…‹
                    } else {
                        console.log(`é‡‘å¹£ä¸è¶³ï¼ éœ€è¦ ${item.cost}, åªæœ‰ ${goldCoins}`);
                        // å¯ä»¥æ·»åŠ ä¸€å€‹çŸ­æš«çš„è¦–è¦ºæç¤ºï¼Œä¾‹å¦‚æŒ‰éˆ•è®Šç´…
                        const clickedButton = event.currentTarget;
                        clickedButton.style.backgroundColor = '#ef4444'; // æš«æ™‚è®Šç´…
                        setTimeout(() => {
                            clickedButton.style.backgroundColor = ''; // æ¢å¾©åŸè‰²
                        }, 300);
                    }
                }
            }

            // äº‹ä»¶ç›£è½å™¨
            // æ»‘é¼ é»æ“Š (å·¦éµæˆ–å³éµ)
            canvas.addEventListener('mousedown', (e) => {
                // æª¢æŸ¥æ˜¯å¦ç‚ºå·¦éµé»æ“Š (e.button === 0) æˆ–å³éµé»æ“Š (e.button === 2)
                if (e.button === 0 || e.button === 2) {
                    character.jump();
                }
                e.preventDefault(); // é˜²æ­¢å³éµèœå–®å½ˆå‡º
            });
            // ç¦ç”¨å³éµèœå–®
            canvas.addEventListener('contextmenu', (e) => e.preventDefault());

            // è§¸æ§é»æ“Š
            canvas.addEventListener('touchstart', (e) => {
                character.jump();
                e.preventDefault(); // é˜²æ­¢æ»¾å‹•æˆ–ç¸®æ”¾
            }, { passive: false }); // ä½¿ç”¨ passive: false ç¢ºä¿ preventDefault æœ‰æ•ˆ

            // é‡æ–°é–‹å§‹æŒ‰éˆ•é»æ“Š
            restartButton.addEventListener('click', () => {
                initGame();
                gameLoop(); // é‡æ–°å•Ÿå‹•éŠæˆ²å¾ªç’°
            });

            // äººç‰©æŒ‰éˆ•é»æ“Š
            characterButton.addEventListener('click', openCustomizationModal);
            closeModalBtn.addEventListener('click', closeCustomizationModal);
            startButton.addEventListener('click', () => {
                startScreen.classList.add('hidden'); // éš±è—é–‹å§‹ç•«é¢
                gameContainer.classList.remove('hidden'); // é¡¯ç¤ºéŠæˆ²å®¹å™¨
                initGame(); // åˆå§‹åŒ–éŠæˆ²ç‹€æ…‹
                gameLoop(); // å•Ÿå‹•éŠæˆ²å¾ªç’°
            });

            // çª—å£å¤§å°æ”¹è®Šæ™‚èª¿æ•´ Canvas
            window.addEventListener('resize', resizeCanvas);

            // éŠæˆ²å•Ÿå‹•
            window.onload = function() {
                // åˆå§‹é¡¯ç¤ºé–‹å§‹ç•«é¢ï¼Œéš±è—éŠæˆ²ç•«é¢
                startScreen.classList.remove('hidden');
                gameContainer.classList.add('hidden');
                resizeCanvas(); // åˆå§‹èª¿æ•´ Canvas å°ºå¯¸
                initializeFirebase(); // åˆå§‹åŒ– Firebase
            };
        }
    </script>
    <style>
        /* CSS æ¨£å¼èˆ‡ä¹‹å‰ç‰ˆæœ¬ç›¸åŒï¼Œç¢ºä¿å¤–è§€ä¸€è‡´ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f0f0;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0;
            overflow: hidden;
        }
        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background-color: #fff;
            border-radius: 16px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.25);
            position: relative;
            width: 90vw;
            height: 90vh;
            max-width: 900px;
            max-height: 600px;
            justify-content: center;
        }
        canvas {
            background-color: #add8e6; /* Fallback color if image fails to load */
            border: 4px solid #333;
            border-radius: 12px;
            display: block;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            touch-action: manipulation;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .score-board {
            font-size: 2.5rem;
            font-weight: bold;
            color: #333;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 20px;
        }
        .game-over-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 3rem;
            font-weight: bold;
            text-align: center;
            border-radius: 12px;
            z-index: 10;
            animation: fadeIn 0.5s ease-out forwards;
        }
        .game-over-message {
            margin-bottom: 15px;
            font-size: 3.5rem;
            color: #ff4d4d;
            text-shadow: 0 0 10px rgba(255, 0, 0, 0.8);
            animation: pulse 1.5s infinite alternate;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes pulse {
            from { transform: scale(1); }
            to { transform: scale(1.05); }
        }

        .game-over-overlay button {
            margin-top: 20px;
            padding: 15px 30px;
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            background: linear-gradient(145deg, #4CAF50, #45a049);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        .game-over-overlay button:hover {
            background: linear-gradient(145deg, #45a049, #3e8e41);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }
        .game-over-overlay button:active {
            transform: translateY(0);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }
        .hidden {
            display: none !important;
        }

        .customization-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20;
        }
        .customization-content {
            background-color: #fff;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
            width: 90%;
            max-width: 500px;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        .customization-content h2 {
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }
        .customization-content h3 {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #555;
        }
        .customization-options-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }
        .customization-option-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            position: relative;
            font-size: 2rem;
        }
        .customization-option-button.selected {
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.5);
        }
        .customization-option-button:hover:not(.selected) {
            border-color: #9ca3af;
        }
        .cost-tag {
            position: absolute;
            bottom: -5px;
            right: -5px;
            background-color: #ef4444;
            color: white;
            font-size: 0.75rem;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 9999px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .cost-tag.unlocked {
            background-color: #22c55e;
        }
        .not-enough-coins {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #add8e6;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 30;
            color: #333;
            font-size: 2.5rem;
            font-weight: bold;
        }
        .start-screen h1 {
            margin-bottom: 40px;
            font-size: 4rem;
            color: #4CAF50;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.2);
        }
        .start-screen button {
            padding: 20px 40px;
            font-size: 2rem;
            font-weight: bold;
            color: white;
            background: linear-gradient(145deg, #4CAF50, #3e8e41);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        .start-screen button:hover {
            background: linear-gradient(145deg, #3e8e41, #367c39);
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.4);
        }
    </style>
</head>
<body>
    <!-- Start Screen -->
    <div id="startScreen" class="start-screen">
        <h1>ç–Šç©æœ¨éŠæˆ²</h1>
        <button id="startButton">é–‹å§‹éŠæˆ²</button>
    </div>

    <!-- Game Container (Initially Hidden) -->
    <div id="gameContainer" class="game-container hidden">
        <div class="score-board">
            <div>å¾—åˆ†: <span id="score">0</span></div>
            <div>é‡‘å¹£: <span id="goldCoins">0</span></div>
        </div>
        <canvas id="gameCanvas"></canvas>
        <div id="gameOverOverlay" class="game-over-overlay hidden">
            <div class="game-over-message">éŠæˆ²çµæŸï¼</div>
            <div id="finalScore"></div>
            <button id="restartButton">é‡æ–°é–‹å§‹</button>
        </div>

        <button id="characterButton" class="absolute bottom-4 left-4 p-3 bg-blue-500 text-white rounded-full shadow-lg hover:bg-blue-600 transition-colors duration-200 z-10">
            äººç‰©
        </button>

        <!-- Character Customization Modal -->
        <div id="characterCustomizationModal" class="customization-modal hidden">
            <div class="customization-content">
                <button id="closeModalBtn" class="absolute top-3 right-3 text-gray-600 hover:text-gray-900 text-2xl font-bold">&times;</button>
                <h2>è‡ªè¨‚è§’è‰²</h2>
                <div class="mb-4 text-lg font-semibold text-center">
                    ä½ çš„é‡‘å¹£: <span id="modalGoldCoins" class="text-yellow-600">0</span>
                </div>

                <div class="mb-6">
                    <h3>è¡£æœé¡è‰²</h3>
                    <div id="bodyColorsContainer" class="customization-options-container">
                        <!-- Color options will be injected here -->
                    </div>
                </div>

                <div class="mb-6">
                    <h3>çœ¼ç›æ¨£å¼</h3>
                    <div id="eyeStylesContainer" class="customization-options-container">
                        <!-- Eye style options will be injected here -->
                    </div>
                </div>

                <!-- Removed accessories section as per user request -->
                <!-- <div class="mb-6">
                    <h3>é£¾å“ (è€³æœµç­‰)</h3>
                    <div id="accessoriesContainer" class="customization-options-container">
                    </div>
                </div> -->
            </div>
        </div>
    </div>
</body>
</html>